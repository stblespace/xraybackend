version: "3.9"

services:
  xray-control-api:
    build: .
    network_mode: host
    env_file: .env
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
    restart: unless-stopped
    depends_on:
      - x-ui
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python - <<'PY'\nimport urllib.request, sys\nurl='http://127.0.0.1:8000/health'\ntry:\n    with urllib.request.urlopen(url, timeout=2) as resp:\n        data = resp.read().decode()\n        sys.exit(0 if 'ok' in data else 1)\nexcept Exception:\n    sys.exit(1)\nPY",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
  x-ui:
    image: ghcr.io/mhsanaei/3x-ui:latest
    volumes:
      - ./3x-ui/db:/etc/x-ui
      - ./3x-ui/cert:/root/cert
    environment:
      XRAY_VMESS_AEAD_FORCED: "false"
      XUI_ENABLE_FAIL2BAN: "true"
    tty: true
    network_mode: host
    restart: unless-stopped
